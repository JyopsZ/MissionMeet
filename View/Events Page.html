<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Events</title>
    <link rel="stylesheet" href="events.css" />
</head>
    <body>
        <nav class="navbar">
            <ul>
                <li><a href="home.html">Home</a></li>
                <li><a href="events.html">Events</a></li>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="members.html">Members</a></li>
            </ul>
        </nav>

        <header>
            <h1>Events</h1>
        </header>

        <!-- Events Section -->
        <section class="events">
            <h2>Upcoming Events</h2>
            <div class="event-container" id="event-container">
                <div class="loader"></div>
            </div>
        </section>

        <!-- Event Details Modal -->
        <div id="eventModal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" id="closeEventModal">&times;</span>
                <h3 id="eventTitle"></h3>
                <p id="eventDetails"></p>
                <p id="eventDate"></p>
                <button id="joinEventBtn">Join Event</button>
                <button id="cancelBtn">Cancel</button>

            </div>
        </div>

        <!-- Confirm Join Modal -->
        <div id="confirmModal" style="display: none;">
            <div class="modal-content">
                <p>Are you sure you want to join this event?</p>
                <button id="confirmJoin">Yes</button>
                <button id="cancelJoin">No</button>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 Mission Meet. All rights reserved.</p>
        </footer>

        <script type="module">
            import { getEvents } from "../Controller/DB_CRUD.js";
            
            let eventsList = [];

            // Fetch and display events when page loads
            document.addEventListener('DOMContentLoaded', async () => {
                eventsList = await getEvents(); // Store events data for later access
                displayEvents(eventsList);
            });

            // Display Events on Page
            function displayEvents(events) {
                const eventsContainer = document.getElementById('event-container');
                const loader = document.querySelector('.loader');
                loader.style.display = 'none';

                if (events.length === 0) {
                    eventsContainer.innerHTML = '<h3>No events found</h3>';
                    return;
                }

                eventsContainer.innerHTML = '';  // Clear container

                events.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-subcontainer';
                    eventElement.innerHTML = `
                        <h3>${event.name}</h3>
                        <p>${event.details}</p>
                        <button class="event-btn" id="viewEventBtn-${event.id}">View Event</button>
                    `;
                    eventsContainer.appendChild(eventElement);

                    // Attach event listener to the newly created button
                    const viewEventBtn = document.getElementById(`viewEventBtn-${event.id}`);
                    viewEventBtn.addEventListener('click', function() {
                        openEventModal(event.id);  // Open the modal when the button is clicked
                    });

                });
            }

            // Fetch Event by ID from the eventsList
            function getEventById(eventId) {
                return eventsList.find(event => event.id === eventId);
            }

            // Open Event Details Modal
            function openEventModal(eventId) {
                const event = getEventById(eventId);  // Get event data by ID
                const modal = document.getElementById('eventModal');
                const title = document.getElementById('eventTitle');
                const details = document.getElementById('eventDetails');
                const date = document.getElementById('eventDate');
                const joinBtn = document.getElementById('joinEventBtn');
                const cancelBtn = document.getElementById('cancelBtn');  // Get the cancel button

                // Fill the modal with event details
                title.textContent = event.name;
                details.textContent = event.details;
                date.textContent = event.date;

                modal.style.display = "block";  // Show the modal

                // Handle join event button click
                joinBtn.onclick = function() {
                    openConfirmJoinModal(eventId);  // Show join confirmation modal when join button is clicked
                };

                // Handle cancel button click (close the modal)
                cancelBtn.addEventListener('click', function() {
                    modal.style.display = "none";  // Hide the modal
                });
            }

            // Close Event Modal
            document.getElementById('closeEventModal').addEventListener('click', function() {
                document.getElementById('eventModal').style.display = "none";  // Close event modal
            });

            // Show Join Confirmation Modal
            function openConfirmJoinModal(eventId) {
                const confirmModal = document.getElementById('confirmModal');
                const confirmJoin = document.getElementById('confirmJoin');
                const cancelJoin = document.getElementById('cancelJoin');

                confirmModal.style.display = "block";  // Show the confirmation modal

                // If "Yes" is clicked, show success message (without DB interaction for now)
                confirmJoin.onclick = function() {
                    confirmModal.style.display = "none";  // Close the confirmation modal
                    alert("You have successfully joined the event!");  // Display success message
                };

                // If "No" is clicked, close the confirmation modal 
                cancelJoin.onclick = function() {
                    confirmModal.style.display = "none";  // Close the confirmation modal
                };
            }
        </script>
    </body>
</html>